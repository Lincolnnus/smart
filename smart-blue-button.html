<!DOCTYPE html>
<html>
<head>
<!-- Blue Button Data Starts Here -->
<script id="blueButtonData">
    var BlueButton = {
        "demographics": {
            "firstName": "David",
            "middleName": null,
            "lastName": "Yun",
            "age": 38,
            "gender": "Male",
            "bloodType": "AB",
            "organDonor": "Yes"
        },
        "address": {
            "street": "123 Anywhere Road",
            "city": "San Francisco",
            "state": "CA",
            "country": "United States",
            "zipCode": 94103
        },
        "allergies":[
            {
                "substance": {
                    "name": "Penicillin",
                    "codeSystemName":"RxNorm", 
                    "codeSystem":"2.16.840.1.113883.6.88",  
                    "code":314422
                },
                "reaction": {
                    "name": "Causes hives.",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":247472004
                },
                "severity": {
                    "name": "Moderate to severe",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":371924009
                },
                "status": {
                    "name": "Active",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":55561003
                },
                "code": {
                    "name": "Drug allergy",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":416098002
                }
            },
            {
                "substance": {
                    "name": "Aspirin",
                    "codeSystemName":"UNII", 
                    "codeSystem":"2.16.840.1.113883.4.9",  
                    "code":"R16CO5Y76E"
                },
                "reaction": {
                    "name": "Wheezing",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":56018004
                },
                "severity": {
                    "name": "Moderate to severe",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":371924009
                },
                "status": {
                    "name": "Active",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":55561003
                },
                "code": {
                    "name": "Drug allergy",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":416098002
                }
            },
            {
                "substance": {
                    "name": "Codeine",
                    "codeSystemName":"UNII", 
                    "codeSystem":"2.16.840.1.113883.4.9",  
                    "code":"Q830PW7520"
                },
                "reaction": {
                    "name": "Nausea",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":73879007
                },
                "severity": {
                    "name": "Moderate to severe",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":371924009
                },
                "status": {
                    "name": "Active",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":55561003
                },
                "code": {
                    "name": "Drug allergy",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":416098002
                }
            }
        ],
        "medications": [
            {
                "product": {
                    "name": "Proventil 0.09 MG/ACTUAT inhalant solution",
                    "codeSystemName": "RxNorm",
                    "codeSystem": "2.16.840.1.113883.6.88",
                    "code": 573621
                },
                "date": {
                    "value": 20110301
                },
                "directions": {
                    "text": "2 puffs QID PRN wheezing"
                },
                "instructions": {
                    "text": "Generic Substitition Allowed"
                },
                "drugVehicle": {
                    "name": "Diethylene Glycol",
                    "codeSystemName": "SNOWMED CT",
                    "codeSystem": "2.16.840.1.113883.6.96",
                    "code":5955009
                },
                "status": {
                    "name": "Active",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":55561003
                },
                "indication": {
                    "name": " Bronchitis",
                    "codeSystemName": "SNOWMED CT",
                    "codeSystem": "2.16.840.1.113883.6.96",
                    "code":32398004
                }
            }
        ],
        "immunizations": [
            {
                "product": {
                    "name": "Tetanus and diphtheria toxoids - preservative free",
                    "codeSystemName": "CVX",
                    "codeSystem": "2.16.840.1.113883.6.59",
                    "code": 573621
                },
                "instructions": {
                    "text": "Possible flu-like symptoms for three days."
                },
                "date": {
                    "value": 19981215
                },
                "status": {
                    "name": "Completed"
                }
            },
            {
                "product": {
                    "name": "Influenza virus vaccine",
                    "codeSystemName": "CVX",
                    "codeSystem": "2.16.840.1.113883.6.59",
                    "code": 33
                },
                "instructions": {
                    "text": "Possible flu-like symptoms for three days."
                },
                "date": {
                    "value": 19980521
                },
                "status": {
                    "name": "Completed"
                }
            }
        ],
        "problems": [
            {
                "problem": {
                    "name": "Pneumonia",
                    "codeSystemName": "SNOWMED CT",
                    "codeSystem": "2.16.840.1.113883.6.96",
                    "code": 233604007
                },
                "date":{
                    "value": 19980301,
                    "onsetAge": 52
                },
                "status": {
                    "name": "Resolved",
                    "codeSystemName":"SNOMED CT", 
                    "codeSystem":"2.16.840.1.113883.6.96",  
                    "code":413322009
                }                
            }
        ],
        "procedures": [
            {
                "procedure": {
                    "name": "Colonic polypectomy",
                    "codeSystemName": "SNOWMED CT",
                    "codeSystem": "2.16.840.1.113883.6.96",
                    "code": 274025005
                },
                "date": {
                    "value": 19980301
                },
                "targetSite": {
                    "name": "Abdomen and pelvis",
                    "codeSystemName": "SNOWMED CT",
                    "codeSystem": "2.16.840.1.113883.6.96",
                    "code": 416949008
                }
            }
        ],
        "encounters": [
            {
                "activity": {
                    "name": "Office consultation - 15m",
                    "codeSystemName": "CPT",
                    "codeSystem": "2.16.840.1.113883.6.12",
                    "code": 99241
                },
                "date": {
                    "value": 20000407
                }
            }
        ],
        "vitalSigns": [
            {
                "date": {
                    "value": 20000407
                },
                "height": {
                    "value": 177,
                    "unit": "cm"
                },
                "weight": {
                    "value": 88,
                    "unit": "kg"
                },
                "bloodPressure": {
                    "systolic": {
                        "value": 132,
                        "unit": "mm[Hg]"
                    },
                    "diastolic": {
                        "value": 86,
                        "unit": "mm[Hg]"
                    }
                }
            },
            {
                "date": {
                    "value": 19980301
                },
                "height": {
                    "value": 177,
                    "unit": "cm"
                },
                "weight": {
                    "value": 86,
                    "unit": "kg"
                },
                "bloodPressure": {
                    "systolic": {
                        "value": 145,
                        "unit": "mm[Hg]"
                    },
                    "diastolic": {
                        "value": 88,
                        "unit": "mm[Hg]"
                    }
                }
            }
        ]
    };
</script>
<!-- Blue Button Data Ends Here -->

<!-- Styles go here -->
<style>
    body {
        background-color: #fff;
        color: #666;
        font-family: Helvetica, sans-serif;
        font-size: 14px;
        line-height: 1.2;
    }

    ol {
        list-style-type: none;
        padding: 0;
    }

    .group {
        margin-bottom: 50px;
    }

    .event {
        margin-bottom: 20px;
        position: relative;
    }

    .event-type-name {
        text-transform: uppercase;
    }

    .event-title {
        border-bottom: 1px dotted #444444;
        font-size: 24px;
        margin-bottom: 8px;
    }

    .event-status {
        background-color: #444444;
        color: #ffffff;
        font-weight: bold;
        padding: 10px;
        position: absolute;
        right: 0;
        text-transform: uppercase;
        top: 0;
    }
</style>
<!-- Styles end -->

</head>

<!-- Body Layout -->
<body>
<div id="content">
    <div id="firstName">firstName</div>
    <div id="lastName">lastName</div>

    <h2>Allergies</h2>
    <ol id="allergies"></ol>

    <h2>Medical History</h2>
    <div id="medical-history"></div>
</div>
</body>
<!-- End Body Layout -->

<!-- Script that takes Blue Button data and places it in the body -->

<script>
    var utils = {
        get: function (elementId) {
            return document.getElementById(elementId);
        },
        make: function (elementName, text) {
            var elem = document.createElement(elementName);
            if (text) {
                elem.appendChild(utils.makeText(text));
            }

            return elem;
        },
        makeText: function (text) {
            return document.createTextNode(text);
        },
        extend: function (dest, src) {
            for (var key in src) {
                if (src.hasOwnProperty(key)) {
                    dest[key] = src[key];
                }
            }
        }
    };

    document.getElementById("firstName").innerHTML = BlueButton.demographics.firstName;
    document.getElementById("lastName").innerHTML = BlueButton.demographics.lastName;

    var i;
    for (i=0; i < BlueButton.allergies.length; i++)
    {
        var newDiv = document.createElement('div');
        newDiv.innerHTML = BlueButton.allergies[i].substance.name;
        document.getElementById("allergies").appendChild(newDiv);
    }

    function makeEventView(event) {
        var li = utils.make('li');
        li.className = 'event';

        var typeNameEl = utils.make('div', event.typeName);
        typeNameEl.className = 'event-type-name';
        li.appendChild(typeNameEl);

        var titleEl = utils.make('div', event.title);
        titleEl.className = 'event-title';
        li.appendChild(titleEl);

        if (event.description) {
            li.appendChild(utils.make('div', event.description));
        }

        var statusEl;
        if (event.status) {
            statusEl = utils.make('div', event.status);
            statusEl.className = 'event-status';
            li.appendChild(statusEl);
        }

        return li;
    }

    function makeGroupView(group) {
        var i;
        var event;
        var container = utils.make('div');
        container.className = 'group';

        var header = utils.make('h3', group.date.toLocaleDateString());
        var eventList = utils.make('ol');
        var events = group.events;
        for (i = 0; i < events.length; i++) {
            event = events[i];
            eventList.appendChild(makeEventView(event));
        }
        container.appendChild(header);
        container.appendChild(eventList);
        return container;
    }

    function parseDateValue(dateValue) {
        // Assumes dateValue is in UTC, formatted as YYYYMMDD.
        dateValue = String(dateValue);
        var year = dateValue.substring(0, 4);
        var month = dateValue.substring(4, 6) - 1;
        var date = dateValue.substring(6, 8);
        return new Date(year, month, date); 
    }

    function makeMedicationEvent(props) {
        return {
            typeName: 'Medication',
            title: props.product.name,
            description: props.directions.text,
            status: props.status.name,
            time: parseDateValue(props.date.value)
        };
    }

    function makeImmunizationEvent(props) {
        return {
            typeName: 'Immunization',
            title: props.product.name,
            description: props.instructions.text,
            status: props.status.name,
            time: parseDateValue(props.date.value)
        };
    }

    function makeProblemEvent(props) {
        return {
            typeName: 'Problem',
            title: props.problem.name,
            description: null,
            status: props.status.name,
            time: parseDateValue(props.date.value)
        };
    }

    function makeProcedureEvent(props) {
        return {
            typeName: 'Procedure',
            title: props.procedure.name,
            description: null,
            status: null,
            time: parseDateValue(props.date.value)
        };
    }

    function makeEncounterEvent(props) {
        return {
            typeName: 'Activity',
            title: props.activity.name,
            description: null,
            status: null,
            time: parseDateValue(props.date.value)
        };
    }

    function getMergedEvents() {
        var events = [];
        var i;

        var medications = BlueButton.medications;
        for (i = 0; i < medications.length; i++) {
            events.push(makeMedicationEvent(medications[i]));
        }

        var immunizations = BlueButton.immunizations;
        for (i = 0; i < immunizations.length; i++) {
            events.push(makeImmunizationEvent(immunizations[i]));
        }

        var problems = BlueButton.problems;
        for (i = 0; i < problems.length; i++) {
            events.push(makeProblemEvent(problems[i]));
        }

        var procedures = BlueButton.procedures;
        for (i = 0; i < procedures.length; i++) {
            events.push(makeProcedureEvent(procedures[i]));
        }

        var encounters = BlueButton.encounters;
        for (i = 0; i < encounters.length; i++) {
            events.push(makeEncounterEvent(encounters[i]));
        }

        return events;
    }

    function groupEventsByDate(events) {
        var dates = [];
        var dateToEvents = {};
        var event;
        var eventTime;
        var date;

        events.sort(function (a, b) {
            return a.time - b.time;
        });

        for (i = 0; i < events.length; i++) {
            event = events[i];
            eventTime = event.time;
            date = new Date(
                eventTime.getUTCFullYear(),
                eventTime.getUTCMonth(),
                eventTime.getUTCDate()
            );
            if (!dateToEvents[date]) {
                dates.push(date);
                dateToEvents[date] = [];
            }

            dateToEvents[date].push(event);
        }

        var groups = [];
        for (i = 0; i < dates.length; i++) {
            date = dates[i];
            groups.push({
                date: date,
                events: dateToEvents[date]
            });
        }

        return groups;
    }

    function init() {
        var events = getMergedEvents();
        var groups = groupEventsByDate(events);
        var medicalHistory = utils.get('medical-history');
        var i;
        for (i = 0; i < groups.length; i++) {
            medicalHistory.appendChild(makeGroupView(groups[i]));
        }
    }

    init();
</script>

<!-- End Script -->

</html>